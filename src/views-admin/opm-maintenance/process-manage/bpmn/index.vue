<template>
  <div class="app-container">
    <el-page-header :content="navTitle" @back="$router.back()" />
    <div id="bpmn">
      <!-- <ProcessPalette /> -->
      <ProcessDesigner
        :key="`designer-${reloadIndex}`"
        ref="processDesigner"
        v-model="xmlString"
        v-bind="controlForm"
        keyboard
        :process-type="bpmnInfoType"
        @element-click="elementClick"
        @init-finished="initModeler"
      />
      <MyProcessPanel v-if="L" :key="`penal-${reloadIndex}`" :bpmn-modeler="modeler" :prefix="controlForm.prefix" class="process-panel" />
      <!-- demo config -->
      <div v-if="L" class="demo-control-bar">
        <div class="open-control-dialog" @click="controlDrawerVisible = true"><i class="el-icon-setting" /></div>
      </div>
      <el-drawer :visible.sync="controlDrawerVisible" size="400px" title="偏好设置" append-to-body destroy-on-close>
        <el-form :model="controlForm" size="small" label-width="100px" class="control-form" @submit.native.prevent>
          <el-form-item label="流程ID">
            <el-input v-model="controlForm.processId" @change="reloadProcessDesigner" />
          </el-form-item>
          <el-form-item label="流程名称">
            <el-input v-model="controlForm.processName" @change="reloadProcessDesigner" />
          </el-form-item>
          <el-form-item label="流转模拟">
            <el-switch v-model="controlForm.simulation" inactive-text="停用" active-text="启用" @change="reloadProcessDesigner" />
          </el-form-item>
          <el-form-item label="禁用双击">
            <el-switch v-model="controlForm.labelEditing" inactive-text="停用" active-text="启用" @change="changeLabelEditingStatus" />
          </el-form-item>
          <el-form-item label="隐藏label">
            <el-switch v-model="controlForm.labelVisible" inactive-text="停用" active-text="启用" @change="changeLabelVisibleStatus" />
          </el-form-item>
          <el-form-item label="流程引擎">
            <el-radio-group v-model="controlForm.prefix" @change="reloadProcessDesigner(true)">
              <el-radio label="camunda">camunda</el-radio>
              <el-radio label="flowable">flowable</el-radio>
              <el-radio label="activiti">activiti</el-radio>
            </el-radio-group>
          </el-form-item>
          <el-form-item label="工具栏">
            <el-radio-group v-model="controlForm.headerButtonSize">
              <el-radio label="mini">mini</el-radio>
              <el-radio label="small">small</el-radio>
              <el-radio label="medium">medium</el-radio>
            </el-radio-group>
          </el-form-item>
        </el-form>
      </el-drawer>
    </div>
    <el-dialog :visible.sync="dialogVisible" title="选择流程类型" :show-close="false" :close-on-click-modal="false" :close-on-press-escape="false">
      <el-form ref="numberValidateForm" label-width="90px">
        <el-form-item label="流程类型" prop="type">
          <el-select v-model="bpmnInfoType" class="filter-item" placeholder="选择流程类型">
            <el-option v-for="item in approveType" :key="item.id" :label="item.dictdataName" :value="item.id" />
          </el-select>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
        <el-button
          type="primary"
          @click="
            dialogVisible = false
            $router.back()
          "
        >取 消</el-button>
        <el-button type="primary" @click="handleSubmit">确 定</el-button>
      </span>
    </el-dialog>
  </div>
</template>

<script>
import translations from './translations'
// 自定义渲染（隐藏了 label 标签）
import CustomRenderer from 'custom-renderer'
// 自定义元素选中时的弹出菜单（修改 默认任务 为 用户任务）
import CustomContentPadProvider from './package/designer/plugins/content-pad'
// 自定义左侧菜单（修改 默认任务 为 用户任务）
import CustomPaletteProvider from './package/designer/plugins/palette'
// import xmlObj2json from './utils/xml2json'
// import ProcessPalette from './package/palette/ProcessPalette'
// 自定义侧边栏
import MyProcessPanel from './package/penal/PropertiesPanel'
import ProcessDesigner from './package/designer/ProcessDesigner'
import request from '@/utils/request'
import api from '@/api/api'
import store from '@/store'

export default {
  name: 'App',
  components: {
    // ProcessPalette,
    MyProcessPanel,
    ProcessDesigner
  },
  data() {
    return {
      xmlString: '',
      modeler: null,
      reloadIndex: 0,
      controlDrawerVisible: false,
      translationsSelf: translations,
      controlForm: {
        processId: '',
        processName: '',
        simulation: true,
        labelEditing: false,
        labelVisible: false,
        prefix: 'activiti',
        headerButtonSize: 'mini',
        // additionalModel: []
        additionalModel: [CustomContentPadProvider, CustomPaletteProvider]
      },
      addis: {
        CustomContentPadProvider,
        CustomPaletteProvider
      },
      bpmnInfoType: '',
      approveType: [],
      dialogVisible: false
    }
  },
  computed: {
    id() {
      // 编辑获取内容
      return this.$route.query.id
    },
    navTitle() {
      // title
      return this.$route.meta.title
    },
    L() {
      return !this.$route.query.l
    }
  },
  mounted() {
    if (!this.id) {
      this.findApproveType()
      this.dialogVisible = true
    }
  },
  methods: {
    initModeler(modeler) {
      setTimeout(() => {
        this.modeler = modeler
        console.log(modeler)
      }, 10)
    },
    reloadProcessDesigner(deep) {
      this.controlForm.additionalModel = []
      for (const key in this.addis) {
        if (this.addis[key]) {
          this.controlForm.additionalModel.push(this.addis[key])
        }
      }
      deep && (this.xmlString = undefined)
      this.reloadIndex += 1
      this.modeler = null // 避免 panel 异常
      // if (deep) {
      //   this.xmlString = undefined;
      //   this.$refs.processDesigner.processRestart();
      // }
    },
    changeLabelEditingStatus(status) {
      this.addis.labelEditing = status ? { labelEditingProvider: ['value', ''] } : false
      this.reloadProcessDesigner()
    },
    changeLabelVisibleStatus(status) {
      this.addis.customRenderer = status ? CustomRenderer : false
      this.reloadProcessDesigner()
    },
    elementClick(element) {
      this.element = element
      // console.log(xmlObj2json(this.xmlString));
      // console.log(this.modeler);
      // if (element.type === "bpmn:UserTask") {
      //   const moddle = window.bpmnInstances.moddle;
      //   const modeling = window.bpmnInstances.modeling;
      //   const child1 = moddle.create("flowable:ChildField", {
      //     id: "child1",
      //     name: "1",
      //     readable: true
      //   });
      //   const child2 = moddle.create("flowable:ChildField", {
      //     id: "child2",
      //     name: "2",
      //     type: "string",
      //     required: true
      //   });
      //   const formProperty = moddle.create("flowable:FormProperty", {
      //     children: [child1, child2]
      //     // children: []
      //   });
      //   const extensionElements = moddle.create("bpmn:ExtensionElements", {
      //     values: [formProperty]
      //   });
      //   modeling.updateProperties(element, {
      //     extensionElements
      //   });
      // }
    },
    async handleSubmit() {
      // const approveTypeMapResult = await this.isHaveApproveTypeMap(this.bpmnInfoType)
      // if (approveTypeMapResult.length > 0) return this.$message({ message: '该流程类型已经有流程图了' })
      this.dialogVisible = false
      let bpmnModelInfo = this.$store.getters.bpmnModelInfo
      if (bpmnModelInfo === null) {
        bpmnModelInfo = { type: this.bpmnInfoType }
      } else {
        bpmnModelInfo.type = this.bpmnInfoType
      }
      store.dispatch('bpmn/setBpmnModelInfo', bpmnModelInfo)
    },
    findApproveType() {
      request({
        url: api.common.findSysDictionaryDetail,
        data: { page: 1, limit: -1, dictCode: 'oa_approve_type' }
      }).then(res => {
        if (res.code === 1) this.approveType = res.data
      })
    },
    // 目前规定一个流程类型只有一个流程图，所以查询一下当前选择的流程类型有没有流程图，有的话不可以新增
    async isHaveApproveTypeMap(type) {
      return new Promise(resolve => {
        request({
          url: api.activity.findNewOaActivity,
          data: { type }
        }).then(res => {
          if (res.code === 1) resolve(res.data)
        })
      })
    }
  }
}
</script>

<style lang="scss" scoped>
@import '~bpmn-js/dist/assets/diagram-js.css';
@import '~bpmn-js/dist/assets/bpmn-font/css/bpmn.css';
@import '~bpmn-js/dist/assets/bpmn-font/css/bpmn-codes.css';

@import '~bpmn-js-properties-panel/dist/assets/bpmn-js-properties-panel.css';

body {
  overflow: hidden;
  margin: 0;
  box-sizing: border-box;
}
#bpmn {
  width: 100%;
  height: 100%;
  box-sizing: border-box;
  display: flex;
  margin-top: 10px;
}
::v-deep .bjs-container {
  .bjs-powered-by {
    display: none;
  }
}
.demo-control-bar {
  position: fixed;
  right: 8px;
  bottom: 8px;
  z-index: 1;
  .open-control-dialog {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    font-size: 32px;
    background: rgba(64, 158, 255, 1);
    color: #ffffff;
    cursor: pointer;
  }
}
.info-tip {
  position: fixed;
  top: 40px;
  right: 500px;
  z-index: 10;
  color: #999999;
}
.control-form {
  .el-radio {
    width: 100%;
    line-height: 32px;
  }
}
body,
body * {
  /* 滚动条 */
  &::-webkit-scrollbar-track-piece {
    background-color: #fff; /*滚动条的背景颜色*/
    -webkit-border-radius: 0; /*滚动条的圆角宽度*/
    border-radius: 0; /*滚动条的圆角宽度*/
  }
  &::-webkit-scrollbar {
    width: 10px; /*滚动条的宽度*/
    height: 8px; /*滚动条的高度*/
  }
  &::-webkit-scrollbar-thumb:vertical {
    /*垂直滚动条的样式*/
    height: 50px;
    background-color: rgba(153, 153, 153, 0.5);
    -webkit-border-radius: 4px;
    border-radius: 4px;
    outline: 2px solid #fff;
    outline-offset: -2px;
    border: 2px solid #fff;
  }
  &::-webkit-scrollbar-thumb {
    /*滚动条的hover样式*/
    background-color: rgba(159, 159, 159, 0.3);
    -webkit-border-radius: 4px;
    border-radius: 4px;
  }
  &::-webkit-scrollbar-thumb:hover {
    /*滚动条的hover样式*/
    background-color: rgba(159, 159, 159, 0.5);
    -webkit-border-radius: 4px;
    border-radius: 4px;
  }
}
</style>
